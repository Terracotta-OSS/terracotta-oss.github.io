<!DOCTYPE html ><html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta http-equiv="Content-Style-Type" content="text/css"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Tuning Off-Heap Store Performance</title><link rel="Prev" href="co-tiers_congfiguration_examples.html" title="Previous"><link rel="Next" href="co-tiers_configuring_disk_store.html" title="Next"><link rel="StyleSheet" href="css/aaa_bigmem_go_all.css" type="text/css" media="all"><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all"><link rel="StyleSheet" href="css/social.css" type="text/css" media="all"><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all"><!--[if IE 7]><link rel="StyleSheet" href="css/aaa_bigmem_go_all_IE7.css" type="text/css" media="all"><![endif]--><link rel="StyleSheet" href="css/print.css" type="text/css" media="print"><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if (window === window.top) {
        // Redirect
        //
        redirect_url = "../index.html#page/bigmemory-go-webhelp/co-tiers_tuning_offheap_store.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></head><body id="pRsJZEMfuJnXPgzMu_002buB19A" class="ww_skin_page_body" onload="Page.OnLoad('../index.html#page/bigmemory-go-webhelp/co-tiers_tuning_offheap_store.html');"><header id="wwconnect_header"><div class="ww_skin_breadcrumbs"><span class="ww_skin_breadcrumbs_parent"><a href="../bigmemory-go-webhelp/to-title_product_documentation.html#wwconnect_header">Product Documentation</a></span><span class="ww_skin_breadcrumbs_divider"> : </span><span class="ww_skin_breadcrumbs_parent"><a href="../bigmemory-go-webhelp/to-title_bigmemory_go_config_guide.html#wwconnect_header">BigMemory Go Configuration Guide</a></span><span class="ww_skin_breadcrumbs_divider"> : </span><span class="ww_skin_breadcrumbs_parent"><a href="../bigmemory-go-webhelp/to-tiers_configuring_storage_tiers.html#wwconnect_header">Configuring Storage Tiers</a></span><span class="ww_skin_breadcrumbs_divider"> : </span><span class="ww_skin_breadcrumbs_current">Tuning Off-Heap Store Performance</span></div><div class="ww_skin_page_toolbar"></div></header><div id="ww3_15_10_9_14_1" class="Heading_3">Tuning Off-Heap Store Performance</div><div id="ww3_15_10_9_14_3_2" class="Body">Memory-related or performance issues that arise during operations can be related to improper allocation of memory to the off-heap store. If performance or functional issues arise that can be traced back to the off-heap store, see the suggested tuning tips in this section.</div><div id="ww3_15_10_9_14_3_4_2" class="Section_Title">General Memory allocation</div><div id="ww3_15_10_9_14_3_4_4" class="Body">Committing too much of a system's physical memory is likely to result in paging of virtual memory to disk, quite likely during garbage-collection operations, leading to significant performance issues. On systems with multiple Java processes, or multiple processes in general, the sum of the Java heaps and off-heap stores for those processes should also not exceed the size of the physical RAM in the system. Besides memory allocated to the heap, Java processes require memory for other items, such as code (classes), stacks, and PermGen.</div><div id="ww3_15_10_9_14_3_4_6" class="Body">Note that MaxDirectMemorySize sets an upper limit for the JVM to enforce, but does not actually allocate the specified memory. Overallocation of direct memory (or buffer) space is therefore possible, and could lead to paging or even memory-related errors. The limit on direct buffer space set by MaxDirectMemorySize should take into account the total physical memory available, the amount of memory that is allotted to the JVM object heap, and the portion of direct buffer space that other Java processes may consume.</div><div id="ww3_15_10_9_14_3_4_8" class="Body">In addition, be sure to allocate at least 15 percent more off-heap memory than the size of your data set. To maximize performance, a portion of off-heap memory is reserved for meta-data and other purposes.</div><div id="ww3_15_10_9_14_3_4_10" class="Body">Note also that there could be other users of direct buffers (such as NIO and certain frameworks and containers). Consider allocating additional direct buffer memory to account for that additional usage.</div><div id="ww3_15_10_9_14_3_6_2" class="Section_Title">Compressed References</div><div id="ww3_15_10_9_14_3_6_4" class="Body">For 64-bit JVMs running Java 6 Update 14 or higher, consider enabling compressed references to improve overall performance. For heaps up to 32GB, this feature causes references to be stored at half the size, as if the JVM is running in 32-bit mode, freeing substantial amounts of heap for memory-intensive applications. The JVM, however, remains in 64-bit mode, retaining the advantages of that mode.</div><div id="ww3_15_10_9_14_3_6_6" class="Body">For the Oracle HotSpot, compressed references are enabled using the option <span class="parmname">-XX:+UseCompressedOops</span>. For IBM JVMs, use <span class="parmname">-Xcompressedrefs</span>.</div><div id="ww3_15_10_9_14_3_8_2" class="Section_Title">Slow Off-Heap Allocation</div><div id="ww3_15_10_9_14_3_8_4" class="Body">Based configuration, usage, and memory requirements, BigMemory could allocate off-heap memory multiple times. If off-heap memory comes under pressure due to over-allocation, the host OS may begin paging to disk, thus slowing down allocation operations. As the situation worsens, an off-heap buffer too large to fit in memory can quickly deplete critical system resources such as RAM and swap space and crash the host OS.</div><div id="ww3_15_10_9_14_3_8_6" class="Body">To stop this situation from degrading, off-heap allocation time is measured to avoid allocating buffers too large to fit in memory. If it takes more than 1.5 seconds to allocate a buffer, a warning is issued. If it takes more than 15 seconds, the JVM is halted with System.exit() (or a different method if the Security Manager prevents this).</div><div id="ww3_15_10_9_14_3_8_8" class="Body">To prevent a JVM shutdown after a 15-second delay has occurred, set the <span class="codeph">net.sf.ehcache.offheap.DoNotHaltOnCriticalAllocationDelay</span> system property to true. In this case, an error is logged instead.</div><div id="ww3_15_10_9_14_3_10_2" class="Section_Title">Swappiness and Huge Pages</div><div id="ww3_15_10_9_14_3_10_4" class="Body">An OS could swap data from memory to disk even if memory is not running low. For the purpose of optimization, data that appears to be unused may be a target for swapping. Because BigMemory can store substantial amounts of data in RAM, its data may be swapped by the OS. But swapping can degrade overall cluster performance by introducing thrashing, the condition where data is frequently moved forth and back between memory and disk.</div><div id="ww3_15_10_9_14_3_10_6" class="Body">To make heap memory use more efficient, Linux, Microsoft Windows, and Oracle Solaris users should review their configuration and usage of swappiness as well as the size of the swapped memory pages. In general, BigMemory benefits from lowered swappiness and the use of <span class="emphasis">huge pages</span> (also known as <span class="emphasis">big pages</span>, <span class="emphasis">large pages</span>, and <span class="emphasis">superpages</span>).</div><div id="ww3_15_10_9_14_3_10_8" class="Body">Settings for these behaviors vary by OS and JVM. For Oracle HotSpot, <span class="codeph">-XX:+UseLargePages</span> and <span class="codeph">-XX:LargePageSizeInBytes=&lt;size&gt;</span> (where &lt;size&gt; is a value allowed by the OS for specific CPUs) can be used to control page size. However, note that this setting does <span class="emphasis">not</span> affect how off-heap memory is allocated. Over-allocating huge pages while also configuring substantial off-heap memory <span class="emphasis">can starve off-heap allocation and lead to memory and performance problems</span>.</div><div id="ww3_15_10_9_14_3_12_2" class="Section_Title">Maximum Serialized Size of an Element</div><div id="ww3_15_10_9_14_3_12_4" class="Body">This section applies when using BigMemory through the Ehcache API.</div><div id="ww3_15_10_9_14_3_12_6" class="Body">Unlike the memory and the disk stores, by default the off-heap store has a 4MB limit for classes with high quality hashcodes, and 256KB limit for those with pathologically bad hashcodes. The built-in classes such as String and the java.lang.Number subclasses Long and Integer have high quality hashcodes. This can issues when objects are expected to be larger than the default limits.</div><div id="ww3_15_10_9_14_3_12_8" class="Body">To override the default size limits, set the system property <span class="codeph">net.sf.ehcache.offheap.cache_name.config.idealMaxSegmentSize</span> to the size you require.</div><div id="ww3_15_10_9_14_3_12_10" class="Body">For example,</div><div id="ww3_15_10_9_14_3_12_12" class="Preformatted">net.sf.ehcache.offheap.com.company.domain.State.config.idealMaxSegmentSize=30M</div><div id="ww3_15_10_9_14_3_14_2" class="Section_Title">Reducing Faulting</div><div id="ww3_15_10_9_14_3_14_4" class="Body">While the memory store holds a hotset (a subset) of the entire data set, the off-heap store should be large enough to hold the entire data set. The frequency of misses (get operations that fail to find the data in memory) begins to rise when the data is too large to fit into off-heap memory, forcing gets to fetch data from the disk store (called <span class="emphasis">faulting</span>). More misses in turn raise latency and lower performance.</div><div id="ww3_15_10_9_14_3_14_6" class="Body">For example, tests with a 4GB data set and a 5GB off-heap store recorded no misses. With the off-heap store reduced to 4GB, 1.7 percent of cache operations resulted in misses. With the off-heap store at 3GB, misses reached 15 percent.</div><footer><!-- Related Topics --><!--                --><!-- Back to Top --><!--             --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><br></footer><div><div style="font-family: Arial, Verdana, Helvetica, Sans-Serif; font-size: 11px; margin-top: 20px; margin-bottom: 20px;"><span class="xref"><a href="http://documentation.softwareag.com/legal/" target="external_window">Copyright © <span>2010</span><span>-2016</span><span></span><span></span> Software AG, Darmstadt, Germany</a></span>.</div><hr></div><div style="font-family: Arial, Verdana, Helvetica, Sans-Serif; font-size: 13px; font-weight: bold; margin-top: 20px;"><span><img style="vertical-align:middle" src="../connect/terracotta_online.png" alt="Product Logo"><a href="https://empower.softwareag.com/ContactSupport/default.asp" target="_blank">Contact&nbsp;Support</a>
         &nbsp;&nbsp;|&nbsp;&nbsp;
       <a href="http://www.softwareag.com/corporate/community/default.asp" target="_blank">Community</a>
         &nbsp;&nbsp;|&nbsp;&nbsp;
       <a href="mailto://documentation@softwareag.com" target="_blank">Feedback&nbsp;&nbsp;</a></span></div></body></html>