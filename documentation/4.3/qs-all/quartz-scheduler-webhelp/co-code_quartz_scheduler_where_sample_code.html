<!DOCTYPE html ><html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta http-equiv="Content-Style-Type" content="text/css"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Sample Code for Quartz Scheduler Where</title><link rel="Prev" href="to-code_quartz_scheduler_where_code_sample.html" title="Previous"><link rel="Next" href="re-javadoc_for_the_quartz_api.html" title="Next"><link rel="StyleSheet" href="css/_qs_all.css" type="text/css" media="all"><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all"><link rel="StyleSheet" href="css/social.css" type="text/css" media="all"><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all"><!--[if IE 7]><link rel="StyleSheet" href="css/_qs_all_IE7.css" type="text/css" media="all"><![endif]--><link rel="StyleSheet" href="css/print.css" type="text/css" media="print"><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if (window === window.top) {
        // Redirect
        //
        redirect_url = "../index.html#page/quartz-scheduler-webhelp/co-code_quartz_scheduler_where_sample_code.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></head><body id="pkLKRGqyZAU8BhngLL77U4g" class="ww_skin_page_body" onload="Page.OnLoad('../index.html#page/quartz-scheduler-webhelp/co-code_quartz_scheduler_where_sample_code.html');"><header id="wwconnect_header"><div class="ww_skin_breadcrumbs"><span class="ww_skin_breadcrumbs_parent"><a href="../quartz-scheduler-webhelp/_qs_all.1.095.html#wwconnect_header">Terracotta Quartz User Guide</a></span><span class="ww_skin_breadcrumbs_divider"> : </span><span class="ww_skin_breadcrumbs_parent"><a href="../quartz-scheduler-webhelp/to-code_quartz_scheduler_where_code_sample.html#wwconnect_header">Quartz Scheduler Where Code Sample</a></span><span class="ww_skin_breadcrumbs_divider"> : </span><span class="ww_skin_breadcrumbs_current">Sample Code for Quartz Scheduler Where</span></div><div class="ww_skin_page_toolbar"></div></header><div id="ww3_12_7_7_1" class="Heading_2">Sample Code for Quartz Scheduler Where</div><div id="ww3_12_7_7_3_2_2" class="Body">In this example, a cluster has Terracotta clients running Quartz Scheduler on the following hosts: node0, node1, node2, node3. These hostnames are used as the instance IDs for the Quartz Scheduler scheduler instances because the following properties are set in quartz.properties as shown here:</div><div id="ww3_12_7_7_3_2_4" class="Preformatted">org.quartz.scheduler.instanceId = AUTO      <br>#This sets the hostnames as instance IDs:      <br>org.quartz.scheduler.instanceIdGenerator.class =       <br>    org.quartz.simpl.HostnameInstanceIdGenerator</div><div id="ww3_12_7_7_3_4_2" class="Section_Title">Setting quartzLocality Properties</div><div id="ww3_12_7_7_3_4_4" class="Body">quartzLocality.properties has the following configuration:</div><div id="ww3_12_7_7_3_4_6" class="Preformatted">org.quartz.locality.nodeGroup.slowJobs = node0, node3      <br>org.quartz.locality.nodeGroup.fastJobs = node1, node2      <br>org.quartz.locality.nodeGroup.allNodes = node0, node1, node2, node3      <br>org.quartz.locality.nodeGroup.slowJobs.triggerGroups = slowTriggers      <br>org.quartz.locality.nodeGroup.fastJobs.triggerGroups = fastTriggers</div><div id="ww3_12_7_7_3_6_2" class="Section_Title">Creating Locality-Aware Jobs and Triggers</div><div id="ww3_12_7_7_3_6_4" class="Body">The following code snippet uses Quartz Scheduler Where to create locality-aware jobs and triggers.</div><div id="ww3_12_7_7_3_6_6" class="Preformatted">// Note the static imports of builder classes that define a Domain Specific Language (DSL).      <br>import static org.quartz.JobBuilder.newJob;      <br>import static org.quartz.TriggerBuilder.newTrigger;      <br>import static org.quartz.locality.LocalityTriggerBuilder.localTrigger;      <br>import static org.quartz.locality.NodeSpecBuilder.node;      <br>import static org.quartz.locality.constraint.NodeGroupConstraint.partOfNodeGroup;      <br>import org.quartz.JobDetail;      <br>import org.quartz.locality.LocalityTrigger;      <br>// Other required imports...      <br>// Using the Quartz Scheduler fluent interface, or the DSL.      <br>/***** Node Group + OS Constraint      <br>Create a locality-aware job that can be run on any node       <br>from nodeGroup "group1" that runs a Linux OS:      <br>*****/      <br>LocalityJobDetail jobDetail1 =      <br>        localJob(      <br>            newJob(myJob1.class)      <br>                .withIdentity("myJob1")      <br>                .storeDurably(true)      <br>                .build())      <br>            .where(      <br>                node()      <br>                    .is(partOfNodeGroup("group1"))      <br>                    .is(OsConstraint.LINUX))      <br>            .build();      <br>// Create a trigger for myJob1:      <br>Trigger trigger1 = newTrigger()      <br>            .forJob("myJob1")      <br>            .withIdentity("myTrigger1")      <br>            .withSchedule(simpleSchedule()      <br>                   .withIntervalInSeconds(10)      <br>                   .withRepeatCount(2))      <br>            .build();      <br>// Create a second job:      <br>JobDetail jobDetail2 = newJob(myJob2.class)      <br>                .withIdentity("myJob2")      <br>                .storeDurably(true)      <br>                .build();      <br>/***** Memory Constraint      <br>Create a locality-aware trigger for myJob2 that will fire on any      <br>node that has a certain amount of free memory available:      <br>*****/      <br>LocalityTrigger trigger2 =      <br>        localTrigger(newTrigger()      <br>            .forJob("myJob2")      <br>            .withIdentity("myTrigger2"))      <br>            .where(      <br>                node()      <br>                    // fire on any node in allNodes      <br>        //  with at least 100MB in free memory.      <br>                    .is(partOfNodeGroup("allNodes"))        <br>                    .has(atLeastAvailable(100, MemoryConstraint.Unit.MB)))        <br>            .build();      <br>/***** A Locality-Aware Trigger For an Existing Job      <br> The following trigger will fire myJob1 on any node in the allNodes group       <br> that's running Linux:      <br>*****/      <br>LocalityTrigger trigger3 =      <br>        localTrigger(newTrigger()      <br>            .forJob("myJob1")      <br>            .withIdentity("myTrigger3"))      <br>            .where(      <br>                node()      <br>                    .is(partOfNodeGroup("allNodes")))      <br>            .build();      <br>/***** Locality Constraint Based on Cache Keys      <br>The following job detail sets up a job (cacheJob) that will be fired on the node      <br>where myCache has, locally, the most keys specified in the collection myKeys.      <br>After the best match is found, missing elements will be faulted in.       <br>If these types of jobs are fired frequently and a large amount of data must      <br>often be faulted in, performance could degrade. To maintain performance, ensure       <br>that most of the targeted data is already cached.      <br>*****/      <br>// myCache is already configured, populated, and distributed.      <br>Cache myCache = cacheManager.getEhcache("myCache");       <br>// A Collection is needed to hold the keys for elements targeted by cacheJob.      <br>// The following assumes String keys.      <br>Set&lt;String&gt; myKeys = new HashSet&lt;String&gt;();      <br>... // Populate myKeys with the keys for the target elements in myCache.      <br>// Create the job that will do work on the target elements.      <br>LocalityJobDetail cacheJobDetail =      <br>        localJob(      <br>            newJob(cacheJob.class)      <br>                .withIdentity("cacheJob")      <br>                .storeDurably(true)      <br>                .build())      <br>                .where(      <br>                    node()      <br>                         .has(elements(myCache, myKeys)))      <br>                .build();</div><div id="ww3_12_7_7_3_6_8" class="Body">Notice that trigger3, the third trigger defined, overrode the <span class="parmname">partOfNodeGroup</span> constraint of myJob1. Where triggers and jobs have conflicting constraints, the triggers take priority. However, since trigger3 did not provide an OS constraint, it did <span class="emphasis">not</span> override the OS constraint in myJob1. If any of the constraints in effect — trigger or job — are not met, the trigger will go into an error state and the job will not be fired.</div><div id="ww3_12_7_7_3_8_2" class="Section_Title">Using CPU-Based Constraints</div><div id="ww3_12_7_7_3_8_4" class="Body">The CPU constraint allows you to run jobs on machines with adequate processing power:</div><div id="ww3_12_7_7_3_8_6" class="Preformatted">...      <br>import static org.quartz.locality.constraint.CpuConstraint.loadAtMost;      <br>...      <br>// Create a locality-aware trigger for someJob.      <br>LocalityTrigger trigger =      <br>        localTrigger(newTrigger()      <br>            .forJob("someJob")      <br>            .withIdentity("someTrigger"))      <br>            .where(      <br>                node()      <br>                    // fire on any node in allNodes      <br>                    // with at most the specified load:      <br>                    .is(partOfNodeGroup("allNodes"))        <br>                    .has(loadAtMost(.80)))        <br>            .build();</div><div id="ww3_12_7_7_3_8_8" class="Body">The load constraint refers to the CPU load (a standard *NIX load measurement) averaged over the last minute. A load average below 1.00 indicates that the CPU is likely to execute the job immediately. The smaller the load, the freer the CPU, though setting a threshold that is too low could make it difficult for a match to be found.</div><div id="ww3_12_7_7_3_8_10" class="Body">Other CPU constraints include <span class="parmname">CpuContraint.coresAtLeast(int amount)</span>, which specifies a node with a minimum number of CPU cores, and <span class="parmname">CpuConstraint.threadsAvailableAtLeast(int amount)</span>, which specifies a node with a minimum number of available threads.</div><div class="ww_skin_page_overflow"><table class="note1" summary=""><tr><td class="Table_Cell" style="padding-right: 6px; vertical-align: top"><div id="ww3_12_7_7_3_8_12_1_3_1_1_1" class="Note"><span style="font-weight: bold">Note:  </span>&nbsp;</div></td><td class="Table_Cell" style="padding-right: 6px; vertical-align: top"><div id="ww3_12_7_7_3_8_12_1_3_1_2" class="Table_Cell">If a trigger cannot fire because it has constraints that cannot be met by any node, that trigger will go into an error state. Applications using Quartz Scheduler Where with constraints should be tested under conditions that simulate those constraints in the cluster.</div></td></tr></table></div><div id="ww3_12_7_7_3_8_14" class="Body">This example showed how memory and node-group constraints are used to route locality-aware triggers and jobs. For example, trigger2 is set to fire myJob2 on a node in a specific group ("allNodes") with a specified minimum amount of free memory. A constraint based on operating system (Linux, Microsoft Windows, Apple OSX, and Oracle Solaris) is also available.</div><footer><!-- Related Topics --><!--                --><!-- Back to Top --><!--             --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><br></footer><div><div style="font-family: Arial, Verdana, Helvetica, Sans-Serif; font-size: 11px; margin-top: 20px; margin-bottom: 20px;"><span class="xref"><a href="http://documentation.softwareag.com/legal/" target="external_window">Copyright © <span>2010</span><span>-2016</span><span></span><span></span> Software AG, Darmstadt, Germany</a></span>.</div><hr></div><div style="font-family: Arial, Verdana, Helvetica, Sans-Serif; font-size: 13px; font-weight: bold; margin-top: 20px;"><span><img style="vertical-align:middle" src="../connect/quartz_online.png" alt="Product Logo"><!--	     <a href="https://empower.softwareag.com/ContactSupport/default.asp" target="_blank" >Contact&#160;Support</a> --><!--         &#160;&#160;|&#160;&#160;  --><!--         <a href="http://www.softwareag.com/corporate/community/default.asp" target="_blank" >Community</a>  --><!--         &#160;&#160;  -->
          |&nbsp;&nbsp;
        <a href="mailto://documentation@softwareag.com" target="_blank">Feedback&nbsp;&nbsp;</a></span></div></body></html>