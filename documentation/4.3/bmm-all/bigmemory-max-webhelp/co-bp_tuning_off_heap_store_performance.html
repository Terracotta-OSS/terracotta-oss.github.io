<!DOCTYPE html ><html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta http-equiv="Content-Style-Type" content="text/css"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Tuning Off-Heap Store Performance</title><link rel="Prev" href="to-title_bigmemory_max_best_practices.html" title="Previous"><link rel="Next" href="co-bp_tuning_heap_memory_performance.html" title="Next"><link rel="StyleSheet" href="css/aaa_bigmem_max_all.css" type="text/css" media="all"><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all"><link rel="StyleSheet" href="css/social.css" type="text/css" media="all"><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all"><!--[if IE 7]><link rel="StyleSheet" href="css/aaa_bigmem_max_all_IE7.css" type="text/css" media="all"><![endif]--><link rel="StyleSheet" href="css/print.css" type="text/css" media="print"><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if (window === window.top) {
        // Redirect
        //
        redirect_url = "../index.html#page/bigmemory-max-webhelp/co-bp_tuning_off_heap_store_performance.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></head><body id="pN0aY3KfhsnUFkt0P17PIarQ" class="ww_skin_page_body" onload="Page.OnLoad('../index.html#page/bigmemory-max-webhelp/co-bp_tuning_off_heap_store_performance.html');"><header id="wwconnect_header"><div class="ww_skin_breadcrumbs"><span class="ww_skin_breadcrumbs_parent"><a href="../bigmemory-max-webhelp/to-title_bigmemory_max_best_practices.html#wwconnect_header">BigMemory Max Best Practices</a></span><span class="ww_skin_breadcrumbs_divider"> : </span><span class="ww_skin_breadcrumbs_current">Tuning Off-Heap Store Performance</span></div><div class="ww_skin_page_toolbar"></div></header><div id="ww3_23_6_1" class="Heading_1">Tuning Off-Heap Store Performance</div><div id="ww3_23_6_2_2" class="Body">Memory-related or performance issues that arise during operations can be related to improper allocation of memory to the off-heap store. If performance or functional issues arise that can be traced back to the off-heap store, see the suggested tuning tips in this section.</div><div id="ww3_23_6_2_4_2" class="Section_Title">General Memory allocation</div><div id="ww3_23_6_2_4_4" class="Body">Committing too much of a system's physical memory is likely to result in paging of virtual memory to disk, quite likely during garbage-collection operations, leading to significant performance issues. On systems with multiple Java processes, or multiple processes in general, the sum of the Java heaps and off-heap stores for those processes should also not exceed the size of the physical RAM in the system. Besides memory allocated to the heap, Java processes require memory for other items, such as code (classes), stacks, and PermGen.</div><div id="ww3_23_6_2_4_6" class="Body">Note that MaxDirectMemorySize sets an upper limit for the JVM to enforce, but does not actually allocate the specified memory. Overallocation of direct memory (or buffer) space is therefore possible, and could lead to paging or even memory-related errors. The limit on direct buffer space set by MaxDirectMemorySize should take into account the total physical memory available, the amount of memory that is allotted to the JVM object heap, and the portion of direct buffer space that other Java processes may consume.</div><div id="ww3_23_6_2_4_8" class="Body">In addition, be sure to allocate at least 15 percent more off-heap memory than the size of your data set. To maximize performance, a portion of off-heap memory is reserved for meta-data and other purposes.</div><div id="ww3_23_6_2_4_10" class="Body">Note also that there could be other users of direct buffers (such as NIO and certain frameworks and containers). Consider allocating additional direct buffer memory to account for that additional usage.</div><div id="ww3_23_6_2_6_2" class="Section_Title">Compressed References</div><div id="ww3_23_6_2_6_4" class="Body">For 64-bit JVMs running Java 6 Update 14 or higher, consider enabling compressed references to improve overall performance. For heaps up to 32GB, this feature causes references to be stored at half the size, as if the JVM is running in 32-bit mode, freeing substantial amounts of heap for memory-intensive applications. The JVM, however, remains in 64-bit mode, retaining the advantages of that mode.</div><div id="ww3_23_6_2_6_6" class="Body">For the Oracle HotSpot, compressed references are enabled using the option <span class="codeph">-XX:+UseCompressedOops</span>. For IBM JVMs, use <span class="codeph">-Xcompressedrefs</span>.</div><div id="ww3_23_6_2_8_2" class="Section_Title">Slow Off-Heap Allocation</div><div id="ww3_23_6_2_8_4" class="Body">Based on configuration, usage, and memory requirements, BigMemory could allocate off-heap memory multiple times. If off-heap memory comes under pressure due to over-allocation, the host OS may begin paging to disk, thus slowing down allocation operations. As the situation worsens, an off-heap buffer too large to fit in memory can quickly deplete critical system resources such as RAM and swap space and crash the host OS.</div><div id="ww3_23_6_2_8_6" class="Body">To stop this situation from degrading, off-heap allocation time is measured to avoid allocating buffers too large to fit in memory. If it takes more than 1.5 seconds to allocate a buffer, a warning is issued. If it takes more than 15 seconds, the JVM is halted with <span class="codeph">System.exit()</span> (or a different method if the Security Manager prevents this).</div><div id="ww3_23_6_2_8_8" class="Body">To prevent a JVM shutdown after a 15-second delay has occurred, set the <span class="codeph">net.sf.ehcache.offheap.DoNotHaltOnCriticalAllocationDelay</span> system property to true. In this case, an error is logged instead.</div><div id="ww3_23_6_2_10_2" class="Section_Title">Maximum Serialized Size of an Element</div><div id="ww3_23_6_2_10_4" class="Body">This section applies when using BigMemory through the Ehcache API.</div><div id="ww3_23_6_2_10_6" class="Body">Unlike the memory and the disk stores, by default the off-heap store has a 4MB limit for classes with high quality hashcodes, and 256KB limit for those with pathologically bad hashcodes. The built-in classes such as <span class="codeph">String</span> and the <span class="codeph">java.lang.Number</span> subclasses Long and Integer have high quality hashcodes. This can issues when objects are expected to be larger than the default limits.</div><div id="ww3_23_6_2_10_8" class="Body">To override the default size limits, set the system property <span class="codeph">net.sf.ehcache.offheap.cache_name.config.idealMaxSegmentSize</span> to the size you require.</div><div id="ww3_23_6_2_10_10" class="Body">For example,</div><div id="ww3_23_6_2_10_12" class="Preformatted">net.sf.ehcache.offheap.com.company.domain.State.config.idealMaxSegmentSize=30M</div><div id="ww3_23_6_2_12_2" class="Section_Title">Reducing Faulting</div><div id="ww3_23_6_2_12_4" class="Body">While the memory store holds a hotset (a subset) of the entire data set, the off-heap store should be large enough to hold the entire data set. The frequency of misses (get operations that fail to find the data in memory) begins to rise when the data is too large to fit into off-heap memory, forcing gets to fetch data from the disk store (called <span class="term">faulting</span>). More misses in turn raise latency and lower performance.</div><div id="ww3_23_6_2_12_6" class="Body">For example, tests with a 4GB data set and a 5GB off-heap store recorded no misses. With the off-heap store reduced to 4GB, 1.7 percent of cache operations resulted in misses. With the off-heap store at 3GB, misses reached 15 percent.</div><div id="ww3_23_6_2_14_2" class="Section_Title">Swappiness and Huge Pages</div><div id="ww3_23_6_2_14_4" class="Body">An operating system (OS) that is swapping to disk can substantially slow down or even stop your application. If the OS is under pressure because Terracotta servers—along with other processes running on a host—are squeezing the available memory, then memory will start to be paged in and out. This type of operation, when too frequent, requires either tuning of the swap parameters or a permanent solution to a chronic lack of RAM.</div><div id="ww3_23_6_2_14_6" class="Body">An OS could swap data from memory to disk even if memory is not running low. For the purpose of optimization, data that appears to be unused may be a target for swapping. Because BigMemory can store substantial amounts of data in RAM, its data may be swapped by the OS. But swapping can degrade overall cluster performance by introducing thrashing, the condition where data is frequently moved forth and back between memory and disk.</div><div id="ww3_23_6_2_14_8" class="Body">To make heap memory use more efficient, Linux, Microsoft Windows, and Oracle Solaris users should review their configuration and usage of swappiness as well as the size of the swapped memory pages. In general, BigMemory benefits from lowered swappiness and the use of <span class="term">huge pages</span> (also known as <span class="term">big pages</span>, <span class="term">large pages</span>, and <span class="term">superpages</span>). Settings for these behaviors vary by OS and JVM. For Oracle HotSpot, <span class="codeph">-XX:+UseLargePages</span> and <span class="codeph">-XX:LargePageSizeInBytes=&lt;size&gt;</span> (where &lt;size&gt; is a value allowed by the OS for specific CPUs) can be used to control page size. However, note that this setting does not affect how off-heap memory is allocated. Over-allocating huge pages while also configuring substantial off-heap memory can starve off-heap allocation and lead to memory and performance problems.</div><div id="ww3_23_6_2_16_2" class="Section_Title">Reduce Swapping</div><div id="ww3_23_6_2_16_4" class="Body">Many tools are available to help you diagnose swapping. Popular options include using a built-in command-line utility. On Linux, for example:</div><div id="ww3_23_6_2_16_6_2" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span>See available RAM with <span class="codeph">free -m</span> (display memory statistics in megabtyes). Pay attention to swap utilization.</div><div id="ww3_23_6_2_16_6_4" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span><span class="codeph">vmstat</span> displays swap-in ("si") and swap-out ("so") numbers. Non-zero values indicate swapping activity. Set <span class="codeph">vmstat</span> to refresh on a short interval to detect trends.</div><div id="ww3_23_6_2_16_6_6" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span>Process status can be used to get detailed information on all processes running on a node. For example, <span class="codeph">ps -eo pid,ppid,rss,vsize,pcpu,pmem,cmd -ww --sort=pmem</span> displays processes ordered by memory use. You can also sort by virtual memory size ("vsize") and real memory size ("rss") to focus on both the most memory-consuming processes and their in-memory footprint.</div><div class="ww_skin_page_overflow"><table class="note1" summary=""><tr><td class="Table_Cell" style="padding-right: 6px; vertical-align: top"><div id="ww3_23_6_2_16_8_1_3_1_1_1" class="Note"><span style="font-weight: bold">Note:  </span>&nbsp;</div></td><td class="Table_Cell" style="padding-right: 6px; vertical-align: top"><div id="ww3_23_6_2_16_8_1_3_1_2" class="Table_Cell">If the JVM is running in a guest virtual host, analyze swapping by both the virtual and underlying host.</div></td></tr></table></div><div id="ww3_23_6_2_16_10" class="Body">If swappiness is being caused by memory pressure, offloading unnecessary or unrelated processes along with running smaller JVMs is often a successful cure. When computing the memory footprint of a JVM, be sure to include the off-heap being allocated.</div><footer><!-- Related Topics --><!--                --><!-- Back to Top --><!--             --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><br></footer><div><div style="font-family: Arial, Verdana, Helvetica, Sans-Serif; font-size: 11px; margin-top: 20px; margin-bottom: 20px;"><span class="xref"><a href="http://documentation.softwareag.com/legal/" target="external_window">Copyright © <span>2010</span><span>-2016</span><span></span><span></span> Software AG, Darmstadt, Germany</a></span>.</div><hr></div><div style="font-family: Arial, Verdana, Helvetica, Sans-Serif; font-size: 13px; font-weight: bold; margin-top: 20px;"><span><img style="vertical-align:middle" src="../connect/terracotta_online.png" alt="Product Logo"><a href="https://empower.softwareag.com/ContactSupport/default.asp" target="_blank">Contact&nbsp;Support</a>
         &nbsp;&nbsp;|&nbsp;&nbsp;
       <a href="http://www.softwareag.com/corporate/community/default.asp" target="_blank">Community</a>
         &nbsp;&nbsp;|&nbsp;&nbsp;
       <a href="mailto://documentation@softwareag.com" target="_blank">Feedback&nbsp;&nbsp;</a></span></div></body></html>