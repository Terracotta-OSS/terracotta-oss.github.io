<!DOCTYPE html ><html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta http-equiv="Content-Style-Type" content="text/css"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Adding the Server Array</title><link rel="Prev" href="co-tutorial_grouping_results.html" title="Previous"><link rel="Next" href="to-title_bigmemory_max_code_samples.html" title="Next"><link rel="StyleSheet" href="css/aaa_bigmem_max_all.css" type="text/css" media="all"><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all"><link rel="StyleSheet" href="css/social.css" type="text/css" media="all"><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all"><!--[if IE 7]><link rel="StyleSheet" href="css/aaa_bigmem_max_all_IE7.css" type="text/css" media="all"><![endif]--><link rel="StyleSheet" href="css/print.css" type="text/css" media="print"><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if (window === window.top) {
        // Redirect
        //
        redirect_url = "../index.html#page/bigmemory-max-webhelp/co-tutorial_adding_server_array.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></head><body id="pfddBh9vmumBTcSqXisjl3A" class="ww_skin_page_body" onload="Page.OnLoad('../index.html#page/bigmemory-max-webhelp/co-tutorial_adding_server_array.html');"><header id="wwconnect_header"><div class="ww_skin_breadcrumbs"><span class="ww_skin_breadcrumbs_parent"><a href="../bigmemory-max-webhelp/to-title_bigmemory_max_tutorials.html#wwconnect_header">Tutorials</a></span><span class="ww_skin_breadcrumbs_divider"> : </span><span class="ww_skin_breadcrumbs_current">Adding the Server Array</span></div><div class="ww_skin_page_toolbar"></div></header><div id="ww3_13_16_1" class="Heading_1">Adding the Server Array</div><div id="ww3_13_16_2_2" class="Body">The Terracotta Server Array is an array of in-memory data servers that plug in seamlessly to provide applications with high-performance, low and predictable latency data access to terabytes of in-memory data and enterprise capabilities like high availability, scalability, fault tolerance and more.</div><div id="ww3_13_16_2_4" class="Body">Let's try starting up a Terracotta server and connecting our data sets to it.</div><div id="ww3_13_16_2_6_2" class="Section_Title">Preparation</div><div id="ww3_13_16_2_6_4_2_2" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span>Add a valid Terracotta license key to the top level of your Terracotta installation directory. If you don't have one yet, you can register for a license at <span class="external"><a href="http://terracotta.org/downloads/bigmemorymax" target="external_window">Terracotta.org/downloads/bigmemorymax</a></span>.</div><div id="ww3_13_16_2_6_4_2_4" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span>Add the following jar in the bigmemory-max-4.x.x download kit to your classpath:</div><div id="ww3_13_16_2_6_4_2_4_3_2" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span>apis/toolkit/lib/terracotta-toolkit-runtime-ee-4.x.x.jar</div><div id="ww3_13_16_2_6_4_2_6" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span>Add the terracotta configuration to the configuration file (see below)</div><div id="ww3_13_16_2_6_4_2_8" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span>Make sure data classes serializable</div><div id="ww3_13_16_2_6_4_2_10" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="bullet.gif" alt="*" border="0" width="10" height="10"></span></span>Start a Terracotta server instance</div><div id="ww3_13_16_2_8_2" class="Section_Title">Create Configuration File</div><div id="ww3_13_16_2_8_4" class="Body">Create a new configuration file called "ehcache-server-array.xml" in your classpath and add a new cache called "server-array" (you can name it anything you want, as long as you use the correct name in your code).</div><div id="ww3_13_16_2_8_6" class="Preformatted">&lt;ehcache xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" <br>     xsi:noNamespaceSchemaLocation="http://ehcache.org/ehcache.xsd" <br>     name="SampleConfig" maxBytesLocalHeap="64M"&gt; <br>  &lt;cache name="hello-world"/&gt; <br>  &lt;cache name="crud"/&gt; <br>  &lt;cache name="search"&gt; <br>    &lt;searchable&gt; <br>        &lt;searchAttribute name="height"/&gt; <br>        &lt;searchAttribute name="weight"/&gt; <br>        &lt;searchAttribute name="bodyMassIndex" /&gt; <br>    &lt;/searchable&gt; <br>  &lt;/cache&gt; <br>  &lt;cache name="sort"&gt; <br>    &lt;searchable&gt; <br>        &lt;searchAttribute name="height"/&gt; <br>        &lt;searchAttribute name="weight"/&gt; <br>    &lt;/searchable&gt; <br>  &lt;/cache&gt; <br>  &lt;cache name="group"&gt; <br>    &lt;searchable&gt; <br>        &lt;searchAttribute name="height"/&gt; <br>        &lt;searchAttribute name="gender"/&gt; <br>        &lt;searchAttribute name="bmi" expression="value.getBodyMassIndex()"/&gt; <br>    &lt;/searchable&gt; <br>  &lt;/cache&gt; <br>  &lt;cache name="server-array"&gt; <br>    &lt;searchable&gt; <br>        &lt;searchAttribute name="height"/&gt; <br>        &lt;searchAttribute name="gender"/&gt; <br>        &lt;searchAttribute name="bmi" expression="value.getBodyMassIndex()"/&gt; <br>    &lt;/searchable&gt; <br>      &lt;!-- Add the terracotta element to this cache. This causes this data <br>      set to be managed by the Terracotta server array. For the purposes of <br>      demonstration, we set the consistency to "strong" to ensure that data <br>      is always consistent across the entire distributed system. There are <br>      other consistency settings that may be more suitable for different <br>      data sets and applications. --&gt; <br>    &lt;terracotta consistency="strong"/&gt; <br>  &lt;/cache&gt; <br>  &lt;!-- Add the terracottaConfig element to specify where to find the <br>  configuration specific to the server array.  In this case, the configuration <br>  is retrieved from the server array itself. --&gt; <br>  &lt;terracottaConfig url="localhost:9510"/&gt; <br>&lt;/ehcache&gt;</div><div id="ww3_13_16_2_10_2" class="Section_Title">Create ServerArrayTest.java</div><div id="ww3_13_16_2_10_4" class="Body">Create and compile a Java class called ServerArrayTest:</div><div id="ww3_13_16_2_10_6" class="Preformatted">import java.io.Serializable; <br>import java.util.List; <br>import net.sf.ehcache.Cache; <br>import net.sf.ehcache.CacheManager; <br>import net.sf.ehcache.Element; <br>import net.sf.ehcache.search.Attribute; <br>import net.sf.ehcache.search.Direction; <br>import net.sf.ehcache.search.Query; <br>import net.sf.ehcache.search.Result; <br>import net.sf.ehcache.search.Results; <br>import net.sf.ehcache.search.aggregator.Aggregators; <br>public class ServerArrayTest { <br>  public static void main(final String[] args) { <br>    // Create a cache manager using the factory method... <br>    final CacheManager cacheManager = CacheManager.newInstance(Group.class <br>        .getResource("/ehcache-server-array.xml")); <br>    // Retrieve the "sort" data set... <br>    final Cache dataSet = cacheManager.getCache("server-array"); <br>    // Check to see if there's any data in it yet... <br>    Element person1 = dataSet.get(1L); <br>    if (person1 == null) { <br>      System.out.println("We didn't find any data in the server array." <br>          + " This must be the first execution."); <br>      // The data isn't in the server array yet (this must be the first time we <br>      // ran the program), so let's create some objects... <br>      final Person janeAusten = new Person(1, "Jane", "Austen", "Female", <br>          5 * 12 + 7, 130); <br>      final Person charlesDickens = new Person(2, "Charles", "Dickens", "Male", <br>          5 * 12 + 9, 160); <br>      final Person janeDoe = new Person(3, "Jane", "Doe", "Female", 5 * 12 + 5, <br>          145); <br>      final Person alexSmith = new Person(4, "Alex", "Smith", "Other", <br>          5 * 12 + 5, 160); <br>      // Put the objects into the data set... <br>      dataSet.put(new Element(janeAusten.getId(), janeAusten)); <br>      dataSet.put(new Element(charlesDickens.getId(), charlesDickens)); <br>      dataSet.put(new Element(janeDoe.getId(), janeDoe)); <br>      dataSet.put(new Element(alexSmith.getId(), alexSmith)); <br>    } else { <br>      System.out.println("We found data in the server array from a previous" <br>          + " execution. No need to create new data."); <br>    } <br>    // Fetch the search attributes that we'll use in our query and when fetching <br>    // our results... <br>    Attribute&lt;Integer&gt; height = dataSet.getSearchAttribute("height"); <br>    Attribute&lt;String&gt; gender = dataSet.getSearchAttribute("gender"); <br>    Attribute&lt;Float&gt; bmi = dataSet.getSearchAttribute("bmi"); <br>    // Create a query object. (This query is designed to select the entire data <br>    // set.) <br>    final Query query = dataSet.createQuery().addCriteria(height.gt(5 * 12)); <br>    // Group by the gender attribute so we can perform aggregations on each <br>    // gender... <br>    query.addGroupBy(gender); <br>    query.includeAttribute(gender); <br>    // Include an aggregation of the average height and bmi of each gender in <br>    // the results... <br>    query.includeAggregator(Aggregators.average(height)); <br>    query.includeAggregator(Aggregators.average(bmi)); <br>    // Include the count of the members of each gender <br>    query.includeAggregator(Aggregators.count()); <br>    // Make the results come back sorted by gender in alphabetical order <br>    query.addOrderBy(gender, Direction.ASCENDING); <br>    // Execute the query... <br>    final Results results = query.execute(); <br>    // Print the results... <br>    for (Result result : results.all()) { <br>      String theGender = result.getAttribute(gender); <br>      List&lt;Object&gt; aggregatorResults = result.getAggregatorResults(); <br>      Float avgHeight = (Float) aggregatorResults.get(0); <br>      Float avgBMI = (Float) aggregatorResults.get(1); <br>      Integer count = (Integer) aggregatorResults.get(2); <br>      System.out.println("Gender: " + theGender + "; count: " + count <br>          + "; average height: " + avgHeight + "; average BMI: " + avgBMI); <br>    } <br>  } <br>  public static class Person implements Serializable { <br>    private static final long serialVersionUID = 1L; <br>    private final String firstName; <br>    private final String lastName; <br>    private final long id; <br>    private final int height; <br>    private final int weight; <br>    private String gender; <br>    public Person(final long id, final String firstName, final String lastName, <br>        final String gender, final int height, final int weight) { <br>      this.id = id; <br>      this.firstName = firstName; <br>      this.lastName = lastName; <br>      this.gender = gender; <br>      this.height = height; <br>      this.weight = weight; <br>    } <br>    public String getFirstName() { <br>      return firstName; <br>    } <br>    public String getLastName() { <br>      return lastName; <br>    } <br>    public String getGender() { <br>      return gender; <br>    } <br>    public int getHeight() { <br>      return height; <br>    } <br>    public int getWeight() { <br>      return weight; <br>    } <br>    public float getBodyMassIndex() { <br>      return ((float) weight / ((float) height * (float) height)) * 703; <br>    } <br>    public long getId() { <br>      return id; <br>    } <br>    public String toString() { <br>      return "[id=" + id + ", firstName=" + firstName + ", lastName=" <br>          + lastName + ", height=" + height + " in" + ", weight=" + weight <br>          + " lbs" + ", bmi=" + getBodyMassIndex() + "]"; <br>    } <br>  } <br>}</div><div id="ww3_13_16_2_12_2" class="Section_Title">Start a Terracotta Server Instance</div><div id="ww3_13_16_2_12_4" class="Body">In a terminal, go to the "server" directory in your BigMemory Max distribution. Then run the start-tc-server command:</div><div id="ww3_13_16_2_12_6" class="Preformatted">%&gt; cd /path/to/bigmemory-max-4.x.x/server <br>%&gt; ./bin/start-tc-server.sh</div><div id="ww3_13_16_2_14_2" class="Section_Title">Execute</div><div id="ww3_13_16_2_14_4" class="Body">The first time you run the ServerArrayTest program in a terminal, there is no data in the server array, so you should see output like this:</div><div id="ww3_13_16_2_14_6" class="Preformatted">We didn't find any data in the server array. This must be the first execution. <br>Gender: Female; count: 2; average height: 66.0; average BMI: 22.242641 <br>Gender: Male; count: 1; average height: 69.0; average BMI: 23.625288 <br>Gender: Other; count: 1; average height: 65.0; average BMI: 26.622484</div><div id="ww3_13_16_2_14_8" class="Body">If you run the ServerArrayTest program again (without restarting the Terracotta server instance that is already running), the data will be automatically retrieved from the server array, so you should see output like this:</div><div id="ww3_13_16_2_14_10" class="Preformatted">We found data in the server array from a previous execution. No need to create new data. <br>Gender: Female; count: 2; average height: 66.0; average BMI: 22.242641 <br>Gender: Male; count: 1; average height: 69.0; average BMI: 23.625288 <br>Gender: Other; count: 1; average height: 65.0; average BMI: 26.622484</div><div id="ww3_13_16_2_14_12" class="Body">In our default configuration, the server keeps all data in memory only (though, you can add easily add data persistence with a fast restartable store configuration). To clear all data, restart the server before you next run the ServerArrayTest program.</div><div id="ww3_13_16_2_16_2" class="Section_Title">Next Steps</div><div id="ww3_13_16_2_16_4" class="Body">This is just a short example of using BigMemory Max with the full power of the server array to help get you started. Keep in mind that the settings we used here were chosen to make it as easy as possible to get started. We encourage you to read the rest of the documentation and experiment with the different configuration options, features and deployment topologies available to best meet your application's performance and scale needs.</div><footer><!-- Related Topics --><!--                --><!-- Back to Top --><!--             --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><br></footer><div><div style="font-family: Arial, Verdana, Helvetica, Sans-Serif; font-size: 11px; margin-top: 20px; margin-bottom: 20px;"><span class="xref"><a href="http://documentation.softwareag.com/legal/" target="external_window">Copyright © <span>2010</span><span>-2016</span><span></span><span></span> Software AG, Darmstadt, Germany</a></span>.</div><hr></div><div style="font-family: Arial, Verdana, Helvetica, Sans-Serif; font-size: 13px; font-weight: bold; margin-top: 20px;"><span><img style="vertical-align:middle" src="../connect/terracotta_online.png" alt="Product Logo"><a href="https://empower.softwareag.com/ContactSupport/default.asp" target="_blank">Contact&nbsp;Support</a>
         &nbsp;&nbsp;|&nbsp;&nbsp;
       <a href="http://www.softwareag.com/corporate/community/default.asp" target="_blank">Community</a>
         &nbsp;&nbsp;|&nbsp;&nbsp;
       <a href="mailto://documentation@softwareag.com" target="_blank">Feedback&nbsp;&nbsp;</a></span></div></body></html>