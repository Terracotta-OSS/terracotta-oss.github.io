<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

  <link rel="shortcut icon"  type="image/x-icon" href="/images/favicon.ico">
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

  <title>Terracotta</title>

  <meta name="description" content="Java's most widely used cache.">

  <link rel="canonical" href="http://www.terracotta.org/documentation/4.1/bigmemorymax/configuration/distributed-configuration.html">
  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Terracotta Feed">


  <!-- Fonts -->
  <link href='https://fonts.googleapis.com/css?family=Lato:300,400,300italic,400italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>

  <!-- Global CSS -->

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/spacelab/bootstrap.min.css">


<!--
  <link rel="stylesheet" href="/plugins/highlight/styles/idea.css">
  <script src="/plugins/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
-->

  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/prettify.css"></script>

  <link rel="stylesheet" href="/css/main.css">

<!--
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
  <script>document.addEventListener('DOMContentLoaded', prettyPrint)</script>
-->

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

</head>


  <body>

    

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="site-title" href="/"><img src="/images/Terracotta_Logo_sm.png" style="margin-top: 12px;"/></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li id="tc_mnu_about"><a href="/about/"><i class="fa fa-info-circle"></i> About</a></li>
            <li id="tc_mnu_docs"><a href="/documentation/"><i class="fa fa-book"></i> Docs</a></li>
            <li id="tc_mnu_download"><a href="/downloads/"><i class="fa fa-download"></i> Download</a></li>
            <li id="tc_mnu_community" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fa fa-users"></i> Community <span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li class="dropdown-header">We Love Contributors</li>
                <li><a href="/community/contribute.html"><i class="fa fa-code"></i> Contributing</a></li>
                <li><a href="/resources/"><i class="fa fa-external-link-square"></i> External Resources</a></li>
                <li><a href="/blog" target="_blank"><i class="fa fa-rss-square"></i> Terracotta Blog</a></li>
                <li role="separator" class="divider"></li>
                <li class="dropdown-header">Forums</li>
                <li><a href="https://groups.google.com/forum/#!forum/terracotta-oss" target="_blank"><i class="fa fa-commenting"></i> Users' Forum</a></li>
                <li role="separator" class="divider"></li>
                <li class="dropdown-header">Source Code</li>
                <li><a href="https://github.com/Terracotta-OSS" target="_blank"><i class="fa fa-github"></i> GitHub  Repositories</a></li>
                <li><a href="http://svn.terracotta.org/svn/tc/" target="_blank"><i class="fa fa-code-fork"></i> SVN  (Terracotta 4.x)</a></li>
                <li role="separator" class="divider"></li>
                <li class="dropdown-header">Bug Tracking</li>
                <li><a href="https://github.com/Terracotta-OSS" target="_blank"><i class="fa fa-bug"></i> GitHub  (use respective project)</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li id="tc_mnu_events"><a href="/events"><i class="fa fa-calendar"></i> News & Events</a></li>
            <li><a href="/blog"><i class="fa fa-rss-square"></i> Terracotta Blog</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

<br/>
<br/>
<br/>


    <div class="container-fluid">
      <div id="contentTitle">
        <h1></h1>
      </div>
      <div>
        <BR/>
        <br/>

<div class="container-fluid">

  <div class="row row-offcanvas row-offcanvas-left">

    <!-- sidebar -->
    <div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar" role="navigation">
        <ul class="nav">
          <li id="tc_mnu_docs_current" class="submenu"><a href="#current_version">Current Documentation</a></li>
          <li id="tc_mnu_doce_release_notes" class="submenu"><a href="http://www.terracotta.org/confluence/display/release/Home" target="_blank">Release Notes</a></li>
          <li id="tc_mnu_docs_previous" class="submenu"><a href="#historical_versions">Historical Versions</a></li>
        </ul>
    </div>

    <!-- main area -->
    <div class="col-xs-12 col-sm-9">
      <header class="post-header">
        
        <h1 class="post-title"></h1>
        <hr/>
        
      </header>
      <article class="post-content">
        <h1 id="distributed-bigmemory-max-configuration-guide-{#94264}">Distributed BigMemory Max Configuration Guide {#94264}</h1><div id="toc-container">
   <table class="toc" id="toc">
      <tbody>
         <tr>
            <td>
               <ul>
                  <li class="toc_level-1 toc_section-1">
                     <a href="#distributed-bigmemory-max-configuration-guide-{#94264}">
                        <span class="toctext">Distributed BigMemory Max Configuration Guide {#94264}</span>
                     </a>
                     <ul>
                        <li class="toc_level-2 toc_section-2">
                           <a href="#introduction">
                              <span class="toctext">Introduction</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-3">
                           <a href="#cachemanager-configuration">
                              <span class="toctext">CacheManager Configuration</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-4">
                           <a href="#terracotta-clustering-configuration-elements-{#95592}">
                              <span class="toctext">Terracotta Clustering Configuration Elements {#95592}</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-5">
                           <a href="#controlling-cache-size-{#78357}">
                              <span class="toctext">Controlling Cache Size {#78357}</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-6">
                           <a href="#setting-cache-eviction-{#24283}">
                              <span class="toctext">Setting Cache Eviction {#24283}</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-7">
                           <a href="#cache-configuration-file-properties-{#11000}">
                              <span class="toctext">Cache-Configuration File Properties {#11000}</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-8">
                           <a href="#cache-events-configuration-{#20075}">
                              <span class="toctext">Cache Events Configuration {#20075}</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-9">
                           <a href="#copy-on-read">
                              <span class="toctext">Copy On Read</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-10">
                           <a href="#configuring-robust-distributed-in-memory-data-sets">
                              <span class="toctext">Configuring Robust Distributed In-memory Data Sets</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-11">
                           <a href="#incompatible-configuration">
                              <span class="toctext">Incompatible Configuration</span>
                           </a>
                        </li>
                        <li class="toc_level-2 toc_section-12">
                           <a href="#exporting-configuration-from-the-terracotta-management-console-{#68288}">
                              <span class="toctext">Exporting Configuration from the Terracotta Management Console {#68288}</span>
                           </a>
                        </li>
                     </ul>
                  </li>
               </ul>
            </td>
         </tr>
      </tbody>
   </table>
</div>

<table>
  <tbody>
    <tr>
      <td>{toc</td>
      <td>2:3}</td>
    </tr>
  </tbody>
</table>

<h2 id="introduction">Introduction</h2>

<p>The BigMemory Max configuration file (<code class="highlighter-rouge">ehcache.xml</code> by default) contains the configuration for one instance of a CacheManager (the Ehcache class managing a set of defined caches). This configuration file must be in your application’s classpath to be found. When using a WAR file, <code class="highlighter-rouge">ehcache.xml</code> should be copied to <code class="highlighter-rouge">WEB-INF/classes</code>.</p>

<p>Note the following about <code class="highlighter-rouge">ehcache.xml</code> in a Terracotta cluster:</p>

<ul>
  <li>The copy on disk is loaded into memory from the first Terracotta client (also called application server or node) to join the cluster.</li>
  <li>Once loaded, the configuration is persisted in memory by the Terracotta servers in the cluster and survives client restarts.</li>
  <li>In-memory configuration can be edited in the Terracotta Management Console (TMC).
  Changes take effect immediately but are <em>not</em> written to the original on-disk copy of <code class="highlighter-rouge">ehcache.xml</code>.</li>
  <li>The in-memory cache configuration is removed with server restarts if the servers are not in persistent mode (<code class="highlighter-rouge">&lt;restartable enabled="false"&gt;</code>), which is the default.
  The original (on-disk) <code class="highlighter-rouge">ehcache.xml</code> is loaded.</li>
  <li>The in-memory cache configuration survives server restarts if the servers are in persistent mode (<code class="highlighter-rouge">&lt;restartable enabled="true"&gt;</code>).
  If you are using the Terracotta servers with persistence of shared data, and you want the cluster to load the original (on-disk) <code class="highlighter-rouge">ehcache.xml</code>, the servers’ database must be wiped by removing the data files from the servers’ <code class="highlighter-rouge">server-data</code> directory. This directory is specified in the Terracotta configuration file in effect (<code class="highlighter-rouge">tc-config.xml</code> by default). Wiping the database causes <em>all persisted shared data to be lost</em>.</li>
</ul>

<p>A minimal distributed-cache configuration should have the following configured:</p>

<ul>
  <li>A <a href="#cachemanager-configuration">CacheManager</a></li>
  <li>A <a href="#70873">Clustering element</a> in individual cache configurations</li>
  <li>A source for <a href="#35085">Terracotta client configuration</a></li>
</ul>

<h2 id="cachemanager-configuration">CacheManager Configuration</h2>
<p>CacheManager configuration elements and attributes are fully described in the <code class="highlighter-rouge">ehcache.xml</code> reference file available in the kit.</p>

<h3 id="via-ehcachexml">Via ehcache.xml</h3>

<p>The attributes of <code class="highlighter-rouge">&lt;ehcache&gt;</code> are:</p>

<ul>
  <li>name –
an optional name for the CacheManager.  The name is optional and primarily used
for documentation or to distinguish Terracotta clustered cache state.  With Terracotta
clustered caches, a combination of CacheManager name and cache name uniquely identify a
particular cache store in the Terracotta clustered memory.
The name will show up in the TMC.</li>
</ul>

<table>
<caption>TIP: Naming the CacheManager</caption>
<tr>
<td>
If you employ multiple Ehcache configuration files, use the <code>name</code> attribute in the &lt;ehcache&gt; element to identify specific CacheManagers in the cluster. The TMC provides a menu listing these names, allowing you to choose the CacheManager you want to view.
</td>
</tr>
</table>

<p>
   <a name="updatecheck" id="updatecheck"></a>
</p>

<ul>
  <li>updateCheck –
an optional boolean flag specifying whether this CacheManager should check
for new versions of Ehcache over the Internet.  If not specified, updateCheck=”true”.</li>
  <li>
    <p>monitoring –
an optional setting that determines whether the CacheManager should
automatically register the SampledCacheMBean with the system MBean server.  Currently,
this monitoring is only useful when using Terracotta clustering. The “autodetect” value detects the presence of Terracotta clustering and registers the MBean.  Other allowed values
are “on” and “off”.  The default is “autodetect”.</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  &lt;Ehcache xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="ehcache.xsd"
  updateCheck="true" monitoring="autodetect"&gt;
</code></pre>
    </div>
  </li>
</ul>

<h3 id="programmatic-configuration">Programmatic Configuration</h3>

<p>CacheManagers can be configured programmatically with a fluent API. The example below
creates a CacheManager with a Terracotta configuration specified in an URL, and creates a defaultCache
and a cache named “example”.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Configuration configuration = new Configuration()
.terracotta(new TerracottaClientConfiguration().url("localhost:9510"))
.defaultCache(new CacheConfiguration("defaultCache", 100))
.cache(new CacheConfiguration("example", 100)
.timeToIdleSeconds(5)
.timeToLiveSeconds(120)
.terracotta(new TerracottaConfiguration()));
CacheManager manager = new CacheManager(configuration);
</code></pre>
</div>

<h2 id="terracotta-clustering-configuration-elements-{#95592}">Terracotta Clustering Configuration Elements {#95592}</h2>

<p>Certain elements in the Ehcache configuration control the clustering of caches with Terracotta.</p>

<p>&lt;a id”96514”&gt;&lt;/a&gt;</p>
<h3 id="terracotta-70873">terracotta {#70873}</h3>

<p>The <code class="highlighter-rouge">&lt;terracotta&gt;</code> element is an optional sub-element of <code class="highlighter-rouge">&lt;cache&gt;</code>. It can be set differently for each <code class="highlighter-rouge">&lt;cache&gt;</code> defined in <code class="highlighter-rouge">ehcache.xml</code>.</p>

<p><code class="highlighter-rouge">&lt;terracotta&gt;</code> has one subelement, <code class="highlighter-rouge">&lt;nonstop&gt;</code> (see <a href="/documentation/4.1/bigmemorymax/configuration/non-stop-cache">Non-Blocking Disconnected (Nonstop) Operation</a> for more information).</p>

<p>The following <code class="highlighter-rouge">&lt;terracotta&gt;</code> attribute allows you to control the type of data consistency for the distributed cache:</p>

<ul>
  <li>
    <p>consistency –  Uses no cache-level locks for better performance  (“eventual” DEFAULT) or uses cache-level locks for immediate cache consistency (“strong”). When set to “eventual”, allows reads without locks, which means the cache may temporarily return stale data in exchange for substantially improved performance. When set to “strong”, guarantees that after any update is completed no local read can return a stale value, but at a potentially high cost to performance, because a large number of locks may need to be stored in client and server heaps.</p>

    <p>Once set, this consistency mode cannot be changed except by reconfiguring the cache using a configuration file and reloading the file. <em>This setting cannot be changed programmatically.</em> See <a href="http://terracotta.org/documentation/4.1/bigmemorymax/configuration/reference-guide#30971">Understanding Performance and Cache Consistency</a> for more information.</p>
  </li>
</ul>

<p>Except for special cases, the following <code class="highlighter-rouge">&lt;terracotta&gt;</code> attributes should operate with their default values:</p>

<ul>
  <li>clustered –  Enables (“true” DEFAULT) or disables (“false”) Terracotta clustering of a specific cache. Clustering is enabled if this attribute is not specified. Disabling clustering also disables the effects of all of the other attributes.</li>
  <li>localCacheEnabled – Enables (“true” DEFAULT) or disables (“false”) local caching of distributed cache data, forcing all of that cached data to reside on the Terracotta Server Array. Disabling local caching may improve performance for distributed caches in write-heavy use cases.</li>
  <li>synchronousWrites –  Enables (“true”) or disables (“false” DEFAULT) synchronous writes from Terracotta clients (application servers) to Terracotta servers. Asynchronous writes (synchronousWrites=”false”) maximize performance by allowing clients to proceed without waiting for a “transaction received” acknowledgement from the server. This acknowledgement is unnecessary in most use cases. Synchronous writes (synchronousWrites=”true”) provide extreme data safety but at a performance cost by requiring that a client receive server acknowledgement of a transaction before that client can proceed. If the cache’s consistency mode is eventual, or while it is set to bulk load using the bulk-load API, only asynchronous writes can occur (synchronousWrites=”true” is ignored).</li>
  <li>concurrency –  Sets the number of segments for the map backing the underlying server store managed by the Terracotta Server Array. If concurrency is not explicitly set (or set to “0”), the system selects an optimized value. See <a href="http://terracotta.org/documentation/4.1/bigmemorymax/configuration/reference-guide#86549">Tuning Concurrency</a> for more information on how to tune this value.</li>
</ul>

<p>The following attributes are used with Hibernate:</p>

<ul>
  <li>localKeyCache –  Enables (“true”) or disables (“false” DEFAULT) a local key cache. BigMemory Max can cache a “hotset” of keys on clients to add locality-of-reference, a feature suitable for read-only cases. Note that the set of keys must be small enough for available memory.</li>
  <li>localKeyCacheSize –  Defines the size of the local key cache in number (positive integer) of elements. In effect if localKeyCache is enabled. The default value, 300000, should be tuned to meet application requirements and environmental limitations.</li>
  <li>orphanEviction –  Enables (“true” DEFAULT) or disables (“false”) orphan eviction. <em>Orphans</em> are cache elements that are not resident in any Hibernate second-level cache but still present on the cluster’s Terracotta server instances.</li>
  <li>orphanEvictionPeriod –  The number of local eviction cycles (that occur on Hibernate) that must be completed before an orphan eviction can take place. The default number of cycles is 4. Raise this value for less aggressive orphan eviction that can reduce faulting on the Terracotta server, or lower it if garbage on the Terracotta server is a concern.</li>
</ul>

<h4 id="default-behavior">Default Behavior</h4>

<p>By default, adding <code class="highlighter-rouge">&lt;terracotta/&gt;</code> to a <code class="highlighter-rouge">&lt;cache&gt;</code> block is equivalent to adding the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;cache name="sampleTerracottaCache"
    maxEntriesLocalHeap="1000"
    eternal="false"
    timeToIdleSeconds="3600"
    timeToLiveSeconds="1800""&gt;
  &lt;persistence strategy="distributed"/&gt;
  &lt;terracotta clustered="true" consistency="eventual" /&gt;
&lt;/cache&gt;
</code></pre>
</div>

<p>&lt;a id”96514”&gt;&lt;/a&gt;</p>
<h3 id="terracottaconfig-35085">terracottaConfig {#35085}</h3>

<p>The <code class="highlighter-rouge">&lt;terracottaConfig&gt;</code> element enables the distributed-cache client to identify a source of Terracotta configuration. It also allows a client to rejoin a cluster after disconnecting from that cluster and being timed out by a Terracotta server. For more information on the rejoin feature, see <a href="http://terracotta.org/documentation/4.1/bigmemorymax/configuration/reference-guide#71266">Using Rejoin to Automatically Reconnect Terracotta Clients</a>. In addition, the <code class="highlighter-rouge">&lt;terracottaConfig&gt;</code> element allows you to enable caches for WAN replication.</p>

<p>The client must load the configuration from a file or a Terracotta server. The value of the <code class="highlighter-rouge">url</code> attribute should contain a path to the file, a system property, or the address and TSA port (9510 by default) of a server.</p>

<table>
<caption>TIP: Terracotta Clients and Servers</caption>
<tr>
<td>
In a Terracotta cluster, the application server is also known as the client.
</td>
</tr>
</table>

<p>For more information on client configuration, see the <em>Clients Configuration Section</em> in the <a href="http://terracotta.org/documentation/4.1/terracotta-server-array/config-reference">Terracotta Configuration Reference</a>.</p>

<h4 id="adding-an-url-attribute">Adding an URL Attribute</h4>

<p>Add the <code class="highlighter-rouge">url</code> attribute to the <code class="highlighter-rouge">&lt;terracottaConfig&gt;</code> element as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;terracottaConfig url="&lt;source&gt;" /&gt;
</code></pre>
</div>

<p>where <code class="highlighter-rouge">&lt;source&gt;</code> must be one of the following:</p>

<ul>
  <li>A path (for example, <code class="highlighter-rouge">url="/path/to/tc-config.xml"</code>)</li>
  <li>An URL (for example, <code class="highlighter-rouge">url="http://www.mydomain.com/path/to/tc-config.xml</code>)</li>
  <li>A system property (for example, <code class="highlighter-rouge">url="${terracotta.config.location}"</code>), where the system property is defined like this:</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>System.setProperty("terracotta.config.location","10.x.x.x:9510"");
</code></pre>
</div>

<ul>
  <li>A Terracotta host address in the form <code class="highlighter-rouge">&lt;host&gt;:&lt;tsa-port&gt;</code> (for example, <code class="highlighter-rouge">url="host1:9510"</code>). Note the following about using server addresses in the form <code class="highlighter-rouge">&lt;host&gt;:&lt;tsa-port&gt;</code>:
    <ul>
      <li>The default TSA port is 9510.</li>
      <li>In a multi-server cluster, you can specify a comma-delimited list (for example, <code class="highlighter-rouge">url="host1:9510,host2:9510,host3:9510"</code>).</li>
      <li>If the Terracotta configuration source changes at a later time, it must be updated in configuration.</li>
    </ul>
  </li>
</ul>

<h4 id="adding-the-wan-attribute">Adding the WAN Attribute</h4>

<p>For each cache to be replicated, its <code class="highlighter-rouge">ehcache.xml</code> configuration file must include the <code class="highlighter-rouge">wanEnabledTSA</code> attribute set to “true” within the <code class="highlighter-rouge">&lt;terracottaConfig&gt;</code> element. Add the <code class="highlighter-rouge">wanEnabledTSA</code> attribute to the <code class="highlighter-rouge">&lt;terracottaConfig&gt;</code> element as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;terracottaConfig wanEnabledTSA="true"/&gt;
</code></pre>
</div>

<p>For more information, refer to <a href="http://terracotta.org/documentation/4.1/wan/introduction">BigMemory WAN Replication</a>.</p>

<h3 id="embedding-terracotta-configuration">Embedding Terracotta Configuration</h3>

<p>You can embed the contents of a Terracotta configuration file in <code class="highlighter-rouge">ehcache.xml</code> as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;terracottaConfig&gt;
   &lt;tc-config&gt;
       &lt;servers&gt;
           &lt;server host="server1" name="s1"/&gt;
           &lt;server host="server2" name="s2"/&gt;
       &lt;/servers&gt;
       &lt;clients&gt;
           &lt;logs&gt;app/logs-%i&lt;/logs&gt;
       &lt;/clients&gt;
   &lt;/tc-config&gt;
&lt;/terracottaConfig&gt;
</code></pre>
</div>

<h2 id="controlling-cache-size-{#78357}">Controlling Cache Size {#78357}</h2>

<p>Certain Ehcache cache configuration attributes affect caches clustered with Terracotta.</p>

<p>See <a href="http://terracotta.org/documentation/4.1/bigmemorymax/configuration/reference-guide#30343">How Configuration Affects Element Eviction</a> for more information on how configuration affects eviction.</p>

<p>To learn about eviction and controlling the size of the cache, see the <a href="/documentation/4.1/bigmemorymax/configuration/data-life">data life</a> and <a href="/documentation/4.1/bigmemorymax/configuration/cache-size">sizing storage tiers</a> pages.</p>

<h2 id="setting-cache-eviction-{#24283}">Setting Cache Eviction {#24283}</h2>
<p>Cache eviction removes elements from the cache based on parameters with configurable values. Having an optimal eviction configuration is critical to maintaining cache performance.</p>

<p>To learn about eviction and controlling the size of the cache, see the <a href="/documentation/4.1/bigmemorymax/configuration/data-life">data life</a> and <a href="/documentation/4.1/bigmemorymax/configuration/cache-size">sizing storage tiers</a> pages.</p>

<p>Ensure that the edited <code class="highlighter-rouge">ehcache.xml</code> is in your application’s classpath. If you are using a WAR file,  <code class="highlighter-rouge">ehcache.xml</code> should be in <code class="highlighter-rouge">WEB-INF/classes</code>.</p>

<p>See <a href="http://terracotta.org/documentation/4.1/bigmemorymax/configuration/reference-guide#30343">How Configuration Affects Element Eviction</a> for more information on how configuration can impact eviction. See <a href="#95592">Terracotta Clustering Configuration Elements</a> for definitions of other available configuration properties.</p>

<h2 id="cache-configuration-file-properties-{#11000}">Cache-Configuration File Properties {#11000}</h2>

<p>See <a href="#95592">Terracotta Clustering Configuration Elements</a> for more information.</p>

<h2 id="cache-events-configuration-{#20075}">Cache Events Configuration {#20075}</h2>

<p>The <code class="highlighter-rouge">&lt;cache&gt;</code> subelement &lt;cacheEventListenerFactory&gt;, which registers listeners for cache events such as puts and updates, has a notification scope controlled by the attribute <code class="highlighter-rouge">listenFor</code>. This attribute can have one of the following values:</p>

<ul>
  <li>local –  Listen for events on the local node. No remote events are detected.</li>
  <li>remote –  Listen for events on other nodes. No local events are detected.</li>
  <li>all –  (DEFAULT) Listen for events on both the local node and on remote nodes.</li>
</ul>

<p>In order for cache events to be detected by remote nodes in a Terracotta cluster, event listeners must have a scope that includes remote events. For example, the following configuration allows listeners of type MyCacheListener to detect both local and remote events:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;cache name="myCache" ... &gt;
 &lt;!-- Not defining the listenFor attribute for &lt;cacheEventListenerFactory&gt; is by default
      equivalent to listenFor="all". --&gt;
 &lt;cacheEventListenerFactory
    class="net.sf.ehcache.event.TerracottaCacheEventReplicationFactory" /&gt;
 &lt;terracotta /&gt;
&lt;/cache&gt;
</code></pre>
</div>

<p>You must use <code class="highlighter-rouge">net.sf.ehcache.event.TerracottaCacheEventReplicationFactory</code> as the factory class to enable cluster-wide cache-event broadcasts in a Terracotta cluster.</p>

<p>See <a href="http://terracotta.org/documentation/4.1/bigmemorymax/configuration/reference-guide#82378">Cache Events in a Terracotta Cluster</a> for more information on cache events in a Terracotta cluster.</p>

<h2 id="copy-on-read">Copy On Read</h2>

<p>The <code class="highlighter-rouge">copyOnRead</code> setting is most easily explained by first examining what it does when not enabled and exploring the potential problems that can arise.
For a cache in which <code class="highlighter-rouge">copyOnRead</code> is NOT enabled, the following reference comparison will always be true:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Object obj1 = c.get("key").getValue();
// Assume no other thread changes the cache mapping between these get() operations ....
Object obj2 = c.get("key").getValue();
if (obj1 == obj2) {
 System.err.println("Same value objects!");
}
</code></pre>
</div>

<p>The fact that the same object reference is returned across multiple <code class="highlighter-rouge">get()</code> operations implies that the cache is storing a direct reference to cache value. This default behavior (copyOnRead=false) is usually desired, although there are at least two scenarios in which it is problematic:</p>

<p>(1) Caches shared between classloaders</p>

<p>and</p>

<p>(2) Mutable value objects</p>

<p>Imagine two web applications that both have access to the same Cache instance (this implies that the core Ehcache classes are in a common classloader). Imagine further that the classes for value types in the cache are duplicated in the web application (so they are not present in the common loader).
In this scenario you would get ClassCastExceptions when one web application accessed a value previously
read by the other application.</p>

<p>One obvious solution to this problem is to move the value types to the
common loader, but another is to enable <code class="highlighter-rouge">copyOnRead</code>. When copyOnRead is in effect, the object references are unique with every <code class="highlighter-rouge">get()</code>. Having unique object references means that the thread context loader of the caller
will be used to materialize the cache values on each <code class="highlighter-rouge">get()</code>. This feature has utility in OSGi environments as well where a common cache service might be shared between bundles.</p>

<p>Another subtle issue concerns mutable value objects in a distributed cache. Consider this simple code with a Cache containing a mutable value type (Foo):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class Foo {
 int field;
}
Foo foo = (Foo) c.get("key").getValue();
foo.field++;
// foo instance is never re-put() to the cache
// ...
</code></pre>
</div>

<p>If the Foo instance is never put back into the Cache your local cache is no longer consistent with the cluster (it is locally modified only). Enabling <code class="highlighter-rouge">copyOnRead</code> eliminates this possibility since the only way to affect cache values is to call mutator methods on the Cache.</p>

<p>It is worth noting that there is a performance penalty to copyOnRead since values are deserialized on every <code class="highlighter-rouge">get()</code>.</p>

<h2 id="configuring-robust-distributed-in-memory-data-sets">Configuring Robust Distributed In-memory Data Sets</h2>

<p>Making the BigMemory Max in-memory data system robust is typically a combination of Ehcache configuration and Terracotta configuration and architecture. For more information, see the following documentation:</p>

<ul>
  <li><a href="/documentation/4.1/bigmemorymax/configuration/non-stop-cache">Nonstop caches</a> – Configure caches to take a specified action after an Ehcache node appears to be disconnected from the cluster.</li>
  <li><a href="/documentation/4.1/bigmemorymax/configuration/reference-guide#71266">Rejoin the cluster</a> – Allow Ehcache nodes to rejoin the cluster as new clients after being disconnected from the cluster.</li>
  <li><a href="/documentation/4.1/terracotta-server-array/high-availability">High Availability in a Terracotta cluster</a> –  Configure nodes to ride out network interruptions and long Java GC cycles, connect to a backup Terracotta server, and more.</li>
  <li><a href="/documentation/4.1/terracotta-server-array/server-arrays">Architecture</a> – Design a cluster that provides failover.</li>
  <li><a href="/documentation/4.1/terracotta-server-array/hybrid">BigMemory Hybrid</a> – Extend BigMemory on Terracotta servers with hybrid storage that can include SSD and Flash technologies as well as DRAM.</li>
</ul>

<h2 id="incompatible-configuration">Incompatible Configuration</h2>

<p>For any clustered cache, you must delete, disable, or edit configuration elements in <code class="highlighter-rouge">ehcache.xml</code> that are incompatible when clustering with Terracotta. Clustered caches have a <code class="highlighter-rouge">&lt;terracotta/&gt;</code> or <code class="highlighter-rouge">&lt;terracotta clustered="true"/&gt;</code> element.</p>

<p>The following Ehcache configuration attributes or elements should be deleted or disabled:</p>

<ul>
  <li>Replication-related attributes such as <code class="highlighter-rouge">replicateAsynchronously</code> and <code class="highlighter-rouge">replicatePuts</code>.</li>
  <li>The attribute <code class="highlighter-rouge">MemoryStoreEvictionPolicy</code> is ignored (a clock eviction policy is used instead), however, if allowed to remain in a clustered cache configuration, the <code class="highlighter-rouge">MemoryStoreEvictionPolicy</code> may cause an exception.</li>
</ul>

<h2 id="exporting-configuration-from-the-terracotta-management-console-{#68288}">Exporting Configuration from the Terracotta Management Console {#68288}</h2>

<p>To create or edit a cache configuration in a live cluster, see <a href="http://terracotta.org/documentation/4.1/tms/tms#42656">Editing Cache Configuration</a>.</p>

<p>To persist custom cache configuration values, create a cache configuration file by exporting customized configuration from the TMC or create a file that conforms to the required format. This file must take the place of any configuration file used when the cluster was last started.</p>

      </article>
    </div>

  </div>

</div>

      </div>
    </div>

    <br/>
<footer class="site-footer">

  <div class="container">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        Related Projects:<br/>
        <a href="http://www.ehcache.org"><img src="/images/ehcache.png" style=""></a><br/><br/>
        <a href="http://www.quartz-scheduler.org"><img src="/images/logo-quartz-scheduler.png" style="max-height: 32px;"></a>

        <!--
        <ul class="contact-list">
          <li>Terracotta</li>
          <li><a href="mailto:tc-oss@softwareag.com">tc-oss@softwareag.com</a></li>
        </ul>
      -->
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/terracotta-oss">
              <i class="fa fa-github"></i> GitHub
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/terracottatech">
              <i class="fa fa-twitter"></i> Twitter
            </a>
          </li>
          

          
          <li>
            <a href="http://www.facebook.com/Terracotta">
              <i class="fa fa-facebook"></i> Facebook
            </a>
          </li>
          

          
          <li>
            <a href="http://www.linkedin.com/company/terracotta">
              <i class="fa fa-linkedin"></i> LinkedIn
            </a>
          </li>
          

          <li>
            <a href="/feed.xml" title="Atom/RSS Feed">
              <i class="fa fa-rss-square"></i> Atom/RSS Feed
            </a>
          </li>
        </ul>
      </div>

    <div class="footer-col  footer-col-3">
      <a href="/downloads/"><i class="fa fa-download"></i> Download Now</a>
      <br/>
      <a href="/documentation/"><i class="fa fa-book"></i> Documentation</a>
      <br/>
      <a href="/resources/"><i class="fa fa-external-link-square"></i> Resources</a>
      <br/>
      <a href="/blog/"><i class="fa fa-rss-square"></i> Terracotat Blog</a>
      <br/>
      <a href="/community/"><i class="fa fa-users"></i> Join the Community</a>
    </div>

    </div>

    <div class="container-fluid">
        <hr/>
        <em class="copyleft">Terracotta is Open Source and freely available under the Terracotta Public License 2.0</em>
        <br/>
        <em class="copyright">&copy; Terracotta, Inc., a wholly-owned subsidiary of Software AG USA, Inc. All rights reserved.</em>
    </div>
  </div>

</footer>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="https://maxcdn.bootstrapcdn.com/js/ie10-viewport-bug-workaround.js"></script>

<!--  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/2.1.0/jquery.scrollTo.min.js"/> -->

<script type="text/javascript">
        $('#').addClass("active");
        $('#').addClass("active");

        //delayed init for documents that need init code that relies on jQuery
        //but jQuery is loaded in the footer
        $(document).ready(function() {
          if(typeof delayedInitHandler == 'function'){
            delayedInitHandler();
          }
        })
</script>


  </body>

</html>
